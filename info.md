## Наблюдения по просадкам FPS при загрузке чанков

- Основной источник лагов при стриминговой подгрузке — функция `Save::load_chunk` (`src/save.cpp`):
  - Выполнялась полная прогонка очередей освещения через `world->propagate_skylight_increase(false, std::numeric_limits<int>::max())` и `world->propagate_increase(false, std::numeric_limits<int>::max())`, то есть без ограничения по количеству шагов и в одном кадре.
  - Там же сразу же перестраивались меши всех субчанков и итоговый меш чанка (`Subchunk::update_mesh()` для всех субчанков + `Chunk::update_mesh()`), хотя уже существует пофреймовая система обновлений через `Chunk::process_chunk_updates()` и `World::chunk_building_queue` с лимитами `Options::CHUNK_UPDATES` и `Options::LIGHT_STEPS_PER_TICK`.
  - В результате, даже при стриминге «по одному чанку за кадр» (`Save::stream_next(1)` в `main.cpp`) отдельные кадры могли попадать на тяжёлый `load_chunk` и проседать по времени рендеринга.

- Дополнительно, при выгрузке дальних чанков в `Save::update_streaming` возможны короткие подвисания из‑за синхронного `save_chunk` (запись NBT + gzip), но это происходит реже и не связано напрямую с появлением новых чанков в поле зрения.

## Внесённые изменения для стабилизации FPS

- `Save::load_chunk` теперь принимает флаг `bool eager_build` (`src/save.h`, `src/save.cpp`):
  - Для первоначальной загрузки мира вокруг игрока (`Save::load`) вызывается `load_chunk(chunk_pos, true)` — поведение освещения сохранено: выполняется полная прогонка световых очередей, чтобы стартовый радиус был сразу корректно освещён.
  - Для стриминговой подгрузки во время игры (`Save::stream_next`) вызывается `load_chunk(pos, false)`.

- При `eager_build == false` (стриминг во время игры):
  - Убраны вызовы `world->propagate_skylight_increase(false, std::numeric_limits<int>::max())` и `world->propagate_increase(false, std::numeric_limits<int>::max())`. Очереди освещения заполняются, но их обработка происходит уже в `World::tick()` с лимитом `Options::LIGHT_STEPS_PER_TICK` за кадр.
  - Убрана немедленная генерация всех мешей чанка: больше не вызываются прямые циклы по `Subchunk::update_mesh()` для всех субчанков и `Chunk::update_mesh()` изнутри `load_chunk`. Вместо этого:
    - Для самого чанка вызывается `c->update_subchunk_meshes()`, что просто заполняет очередь `chunk_update_queue` внутри чанка.
    - Для соседних чанков по сторонам также вызывается `update_subchunk_meshes()` через `update_neighbor`, чтобы границы обновились корректно, но само тяжёлое построение мешей выполняется позже.

- Теперь тяжёлые операции распределены по кадрам в `World::tick()`:
  - Освещение: `propagate_increase(true)` и `propagate_skylight_increase(true)` используют `Options::LIGHT_STEPS_PER_TICK` (по умолчанию 2048 шагов за тик), что ограничивает время работы BFS на кадр.
  - Меши: `Chunk::process_chunk_updates()` обрабатывает не более `Options::CHUNK_UPDATES` субчанков за тик, а `World::chunk_building_queue` вызывает `Chunk::update_mesh()` максимум для одного чанка за кадр.

- Эффект:
  - При входе в новые области мира, когда подгружаются чанки через `Save::stream_next(1)`, тяжёлая работа (освещение и генерация мешей) больше не выполняется целиком в одном вызове `load_chunk`, а размазывается по нескольким последующим кадрам.
  - Просадки FPS от резких пиков CPU‑нагрузки при появлении новых чанков должны заметно уменьшиться; цена — новые чанки могут «достраиваться» визуально за несколько кадров вместо мгновенного появления, но фреймтайм становится значительно ровнее.

- Тесты:
  - `mc_tests.exe` после изменений: 22 теста проходят, 1 (`skylight_open_sky`) падает из‑за текущей семантики `World::get_skylight` (пустой мир возвращает 0 для неинициализированных чанков). Это существующее расхождение ожиданий теста и текущей логики освещения и не связано с изменениями в загрузке чанков.
